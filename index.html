<!DOCTYPE html>
<html lang="de">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="version" content="0.0.2">
<meta name="description" content="Local Wiki Crawler downloads most read Wikipedia Articles.">
<head>
    <title>LWC</title>
    <style>
        body {
            font-family: "Liberation Sans", serif;
            font-size: 2vw;
        }

        a {
            color: inherit;
            text-decoration: none;
        }
    </style>
</head>
<body>
<h1>Local Wiki Crawler by <a href="https://jpkmiller.github.io">jpkmiller</a></h1>
<h2>Wiki. Offline. Everywhere.</h2>
<p id="download">
    <button id="download-wiki-btn">Download from german Wikipedia</button>
</p>
<p id="search">
    <label for="search-input">Search</label>
    <input id="search-input"/>
</p>
<script>
    const QUERY_WIKIPEDIA_DE = "https://de.wikipedia.org/w/api.php?action=query&prop=extracts&exintro=true&explaintext=true&excontinue=0&format=json&origin=*&titles="
    const QUERY_TRENDING_WIKIPEDIA_DE = "https://wikimedia.org/api/rest_v1/metrics/pageviews/top/de.wikipedia/all-access/YEAR/MONTH/all-days"

    function getCachedItem(query) {
        return localStorage.getItem(query)
    }

    function saveItem(query, value) {
        localStorage.setItem(query, value)
    }

    async function getWikiItem(query) {
        const response = await fetch(`${QUERY_WIKIPEDIA_DE}${query}`)
        if (!response.ok) {
            throw Error(response.statusText)
        }
        return await response.json()
    }

    function searchItem(query, callback) {
        console.log(`Searching for ${query}`)
        const cachedItem = getCachedItem(query)
        if (cachedItem !== null) {
            callback(cachedItem)
        } else {
            try {
                getWikiItem(query)
                    .then(item => {
                        const page = Object.keys(item.query.pages)[0]
                        const extractedData = item.query.pages[page].extract
                        if (typeof extractedData !== 'undefined') {
                            saveItem(query, extractedData)
                        }
                        callback(extractedData)
                    }).catch(e => e.message)
            } catch (err) {
                console.error(err)
            }
        }
    }

    function saveDatabase() {
        const xhr = new XMLHttpRequest();
        console.log('Downloading Wiki Database')

        xhr.onreadystatechange = function () {
            const data = JSON.parse(this.response)
            if ('articles' in data.items[0]) {
                const articles = data.items[0].articles
                const articlesLen = articles.length
                for (let i = 0; i < articlesLen; i++) {
                    setTimeout(() => {
                        searchItem(articles[i].article, () => {
                        })
                    }, 100)
                }
            }
        }

        const YEAR = new Date().getFullYear().toString()
        const MONTH = ('0' + (new Date().getMonth())).slice(-2) /* https://stackoverflow.com/a/3605248 */

        xhr.open('GET', `${QUERY_TRENDING_WIKIPEDIA_DE.replace('YEAR', YEAR.toString()).replace('MONTH', MONTH)}`, true)
        xhr.send()
    }

    document.getElementById('download-wiki-btn').addEventListener('click', saveDatabase)
</script>
</body>
</html>